---
title: "FIGI Folate Post Harmonization - ONGOING"
bibliography: /home/rak/Dropbox/library.bib
output: 
  #pdf_document:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: united
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<style type="text/css">
	h1 { /* Header 1 */
			font-size: 24px;
		font-weight: bold;
	}
h2 { /* Header 2 */
		font-size: 18px;
	font-weight: bold;
}
h3 { /* Header 2 */
		font-size: 14px;
	font-weight: bold;
}
hr {
	border: 1px solid #000;
}
</style>

# Folate

## Harmonization

__Dietary Folate__  
- prior fortification: mcg natural food folate  
- after fortification: mcg natural food folate + 1.7 * mcg folic acid from fortified foods  

__Supplemental Folate__  
- folic acid from supplements (single or multivitamins)  
- for studies with binary variables (regular user yes/no), assume 400mcg/day or 400mcg/tablets  

__Total Folate__  
- Total = mcg dietary folate + 1.7 folic acid from supplements  
<br>

Units: mcg/day  

Typically scaled @ 500 mcg/day (e.g. Kantor 2014)  

(Recommended daily value = 400 mcg/day)  
<br>

<!-- # Case/Control/AdvAdenoma counts by studyname -->
<!-- GxE Epi dataset **N = 102,799** -->
<!-- ```{r results='asis', message = F, echo = F, warning = F} -->
<!-- #------ Assemble Counts Table ------# -->
<!-- library(tidyverse) -->
<!-- library(data.table) -->
<!-- library(ggplot2) -->
<!-- library(kableExtra) -->

<!-- finalt <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_counts.rds") -->

<!-- kable(finalt) %>% -->
<!-- 	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') -->
<!-- ``` -->

# Tables
```{r , message=F, echo=F, warning=F, tidy=T}
library(tidyverse)
library(table1)

rm(list = ls())
Epi <- readRDS("~/git/DATA/FIGI_EpiData_rdata/FIGI_Genotype_Epi_181120_EpiOnly.rds")

numeric_vars <- c("age_ref", "fiber", "calcium_tot", "fruit", "vegetable", "redmeat", "procmeat")
epidat <- Epi %>% 
  filter(drop == 0 & gxe == 1) %>% 
  mutate_at(numeric_vars, as.numeric) %>% 
  mutate(sex = factor(sex, labels = c('Female', 'Male')),
         alcoholc = fct_shift(factor(alcoholc, labels = c("N/A", ">28g/d", "1-28g/d", "nondrinker")), 1),
         smoke = fct_shift(factor(smoke, labels = c("N/A", "Former smoke", "Never smoker", "Smoker")),1),
         famhx1 = fct_shift(factor(famhx1, labels = c("N/A", "No", "Yes")), 1),
         folate_totqc2 = factor(folate_totqc2, labels = c("N/A", "Q1", "Q2", "Q3", "Q4")))

label(epidat$age_ref) <- "Age"
label(epidat$fiber) <- "Fiber Intake"
label(epidat$calcium_tot) <- "Total Calcium Intake"
label(epidat$fruit) <- "Fruit Intake"
label(epidat$vegetable) <- "Vegetable Intake"
label(epidat$redmeat) <- "Redmeat Intake"
label(epidat$procmeat) <- "Processed Meat Intake"
label(epidat$sex) <- "Sex"
label(epidat$alcoholc) <- "Alcohol Intake"
label(epidat$smoke) <- "Smoking"
label(epidat$famhx1) <- "Family History of CRC"

label(epidat$folate_totqc2) <- "Total Folate"

# render 
my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=2), 
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
  c("", sapply(stats.default(x), 
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}
table1(~ age_ref + sex + alcoholc + smoke + famhx1 + calcium_tot + fruit + vegetable + redmeat + procmeat | folate_totqc2 , 
       data=epidat,
       render.continuous=my.render.cont, render.categorical=my.render.cat)

```



# Outcome Counts
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_outcome_barplot.png)
<br>

# Folate Distribution

## Total Folate - All Studies
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_boxplot.png)
<br>

## Total Folate - Cohort vs CaseControl
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_boxplot_caco.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_boxplot_cohort.png){ width=49% }  
<br>

## Total Folate - USA vs Other
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_boxplot_usa.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_boxplot_other.png){ width=49% }  
<br>

## Dietary Folate - All Studies
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_boxplot.png)
<br>

## Dietary Folate - Cohort vs CaseControl
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_boxplot_caco.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_boxplot_cohort.png){ width=49% }  
<br>

## Dietary Folate - USA vs Other
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_boxplot_usa.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_boxplot_other.png){ width=49% }  
<br>

## Supplemental Folate - All Studies
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_boxplot.png)
<br>

## Supplemental Folate - Cohort vs CaseControl
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_boxplot_caco.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_boxplot_cohort.png){ width=49% }  
<br>

## Supplemental Folate - USA vs Other
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_boxplot_usa.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_boxplot_other.png){ width=49% }  
<br>

# Folate Distribution by Sex

## Total Folate - Study Design
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_violin_caco_cohort_filter.png)
<br>

## Total Folate - USA vs Other
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_violin_usa_other_filter.png)
<br>

## Dietary Folate - Study Design
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_violin_caco_cohort_filter.png)
<br>

## Dietary Folate - USA vs Other
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_violin_usa_other_filter.png)
<br>

## Supplemental Folate - Study Design
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_violin_caco_cohort_filter.png)
<br>

## Supplemental Folate - USA vs Other
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_violin_usa_other_filter.png)
<br>

-------

# Folate meta-analyses - All Studies

## Total Folate
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_fp_caco_cohort.png)
<br>

### Total Folate 'mega analysis'
```{r , message = F, echo = F, warning = F, tidy=T}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

dat <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_mega.rds")

x <- glm(outcome ~ sex + age_ref + energytot + folate_tot_500 + studyname, data = dat, family = 'binomial')
results <- tidy(x) %>% 
  mutate(or = exp(estimate)) %>% 
  filter(grepl("folate", term))

kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```

## Dietary Folate
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_fp_caco_cohort.png)
<br>

### Dietary Folate 'mega analysis'
```{r , message = F, echo = F, warning = F, tidy=T}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

dat <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_mega.rds")

x <- glm(outcome ~ sex + age_ref + energytot + folate_diet_500 + studyname, data = dat, family = 'binomial')
results <- tidy(x) %>% 
  mutate(or = exp(estimate)) %>% 
  filter(grepl("folate", term))

kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```
## Supplemental Folate
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_fp_caco_cohort.png)
<br>


### Supplemental Folate 'mega analysis'
```{r , message = F, echo = F, warning = F, tidy=T}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

dat <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_mega.rds")

x <- glm(outcome ~ sex + age_ref + energytot + folate_sup_500 + studyname, data = dat, family = 'binomial')
results <- tidy(x) %>% 
  mutate(or = exp(estimate)) %>% 
  filter(grepl("folate", term))

kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```

## Total Folate by study design
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_fp_caco.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_fp_cohort.png){ width=49% }  
<br>

## Total Folate by study country
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_fp_usa.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_fp_other.png){ width=49% }  
<br>

## Dietary Folate by study design
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_fp_caco.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_fp_cohort.png){ width=49% }  
<br>

## Dietary Folate by study country
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_fp_usa.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_diet_fp_other.png){ width=49% }  
<br>

## Supplemental Folate by study design
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_fp_caco.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_fp_cohort.png){ width=49% }  
<br>

## Supplemental Folate by study country
![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_fp_usa.png){ width=49% } ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_sup_fp_other.png){ width=49% }  
<br>

------


# Heterogeneity by study characteristics

## Meta-regression steps:
1) Fit regression models (outcome ~ age_ref + sex + energytot + exposure) for each studyname
2) Fit inverse variance weighted linear model on regression estimates (e.g. `estimates ~ study_design`)
<br>

## Total Folate (CC = 0, Cohort = 1)

```{r , message = F, echo = F, warning = F}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_tot_500_heterogeneity_studydesign.rds")

# Meta regression
w <- (r_glm$std.error)^2
x <- lm(estimate ~ study_design, data = r_glm, weights = w)

# Summary
results <- tidy(x) %>% filter(term == "study_design")
kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```

## Total Folate (Other = 0, USA = 1)

```{r , message = F, echo = F, warning = F}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_tot_500_heterogeneity_usa.rds")

# Meta regression
w <- (r_glm$std.error)^2
x <- lm(estimate ~ country, data = r_glm, weights = w)

# Summary
results <- tidy(x) %>% filter(term == "country")
kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```
<br>

## Dietary Folate (CC = 0, Cohort = 1)

```{r , message = F, echo = F, warning = F}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_diet_500_heterogeneity_studydesign.rds")

# Meta regression
w <- (r_glm$std.error)^2
x <- lm(estimate ~ study_design, data = r_glm, weights = w)

# Summary
results <- tidy(x) %>% filter(term == "study_design")
kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```

## Dietary Folate (Other = 0, USA = 1)

```{r , message = F, echo = F, warning = F}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_diet_500_heterogeneity_usa.rds")

# Meta regression
w <- (r_glm$std.error)^2
x <- lm(estimate ~ country, data = r_glm, weights = w)

# Summary
results <- tidy(x) %>% filter(term == "country")
kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```
<br>


## Supplemental Folate (CC = 0, Cohort = 1)

```{r , message = F, echo = F, warning = F}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_sup_500_heterogeneity_studydesign.rds")

# Meta regression
w <- (r_glm$std.error)^2
x <- lm(estimate ~ study_design, data = r_glm, weights = w)

# Summary
results <- tidy(x) %>% filter(term == "study_design")
kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```

## Supplemental Folate (Other = 0, USA = 1)

```{r , message = F, echo = F, warning = F}
#------ Assemble Counts Table ------#
library(tidyverse)
library(broom)
library(data.table)
library(ggplot2)
library(kableExtra)

r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/folate_sup_500_heterogeneity_usa.rds")

# Meta regression
w <- (r_glm$std.error)^2
x <- lm(estimate ~ country, data = r_glm, weights = w)

# Summary
results <- tidy(x) %>% filter(term == "country")
kable(results) %>%
	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left')

```

<!-- # Total Folate meta-analyses - heterogeneity by study design -->

<!-- ## Case-control vs. Cohort -->
<!-- ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_500_fp_caco.png){ width=49% } -->
<!-- ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_500_fp_cohort.png){ width=49% } -->


<!-- ### Heterogeneity (study_design 0 = CC, 1 = Cohort) -->

<!-- Meta-regression steps:   -->
<!-- 1) Fit regression models (outcome ~ age_ref + sex + energytot + exposure) for each studyname   -->
<!-- 2) Fit weighted linear model on regression estimates (estimates ~ study_design)  -->
<!-- <br> -->


<!-- ```{r , message = F, echo = F, warning = F} -->
<!-- #------ Assemble Counts Table ------# -->
<!-- library(tidyverse) -->
<!-- library(broom) -->
<!-- library(data.table) -->
<!-- library(ggplot2) -->
<!-- library(kableExtra) -->

<!-- r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/heterogeneity_studydesign.rds") -->

<!-- kable(r_glm) %>% -->
<!-- 	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') -->

<!-- # Meta regression -->
<!-- w <- (r_glm$std.error)^2 -->
<!-- x <- lm(estimate ~ study_design, data = r_glm, weights = w) -->

<!-- # Summary -->
<!-- results <- tidy(x) %>% filter(term == "study_design") -->
<!-- kable(results) %>% -->
<!-- 	kable_styling(bootstrap_options = "striped", full_width = F, position = 'center') -->

<!-- ``` -->




<!-- # Total Folate meta-analyses - heterogeneity by Country -->

<!-- ## USA vs Non-USA -->
<!-- ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_500_fp_usa.png){ width=49% } -->
<!-- ![](/home/rak/Dropbox/code/FIGI_PostHarmonization/working/figi_postharm_folate_tot_500_fp_other.png){ width=49% } -->


<!-- ### Heterogeneity (country 0 = Non-USA, 1 = USA) -->

<!-- ```{r , message = F, echo = F, warning = F} -->
<!-- #------ Assemble Counts Table ------# -->
<!-- library(tidyverse) -->
<!-- library(broom) -->
<!-- library(data.table) -->
<!-- library(ggplot2) -->
<!-- library(kableExtra) -->

<!-- r_glm <- readRDS("~/Dropbox/code/FIGI_PostHarmonization/working/heterogeneity_usa.rds") -->

<!-- # kable(r_glm) %>% -->
<!-- # 	kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') -->

<!-- # Meta regression -->
<!-- w <- (r_glm$std.error)^2 -->
<!-- x <- lm(estimate ~ country, data = r_glm, weights = w) -->

<!-- # Summary -->
<!-- results <- tidy(x) %>% filter(term == "country") -->
<!-- kable(results) %>% -->
<!-- 	kable_styling(bootstrap_options = "striped", full_width = F, position = 'center') -->

<!-- ``` -->
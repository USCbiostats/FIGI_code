---
title: "FIGI NSAIDs Post Harmonization"
bibliography: /home/rak/Dropbox/library.bib
output: 
  #pdf_document:
  html_document:
    css: styles_rmarkdown.css
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    theme: united
---

<style type="text/css">
.main-container {
  max-width: 1500px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, echo=F, message=F, cache=F}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(broom)
library(table1)
library(kableExtra)
library(rlang)
library(rmeta)
library(qqman) 

# for counts tables
col.from <- c('Case_0', 'Case_1', 'Case_NA', 'Control_0', 'Control_1', 'Control_NA')
col.to <- c('No', 'Yes', 'NAs', 'No', 'Yes', 'NAs')

# functions
meta_fp <- function(counts_df, results_df, title) {
  tmp_meta <- meta.summaries(results_df$estimate, results_df$std.error, method = 'random')
  tmp_meta_b_ci <- c(tmp_meta[[3]], tmp_meta[[3]]-(tmp_meta[[4]]*1.96), tmp_meta[[3]]+(tmp_meta[[4]]*1.96))
  tmp_fp <- dplyr::select(results_df, estimate, conf.low, conf.high)
  tmp_fp <- rbind(rep(NA, 3), tmp_fp, rep(NA, 3), tmp_meta_b_ci)
  tmp_label_summary <- c("Summary", sum(counts_df$N), sum(counts_df$Case), round(tmp_meta[[3]], 2), round(tmp_meta[[4]], 3), round(exp(tmp_meta[[3]]), 2), round(tmp_meta[[5]][2], 4))
  tmp_label <- inner_join(counts_df, results_df, by = 'studyname') %>% 
    mutate(Study = as.character(studyname), 
           OR = round(exp(estimate), 2),
           Pvalue = round(p.value, 4),
           SE = round(std.error, 3),
           beta = round(estimate, 2)) %>% 
    dplyr::select(Study, N, Case, beta, SE, OR, Pvalue)
  tmp_label2 <- rbind(colnames(tmp_label), tmp_label, rep(NA, 7), tmp_label_summary)
  rmeta::forestplot(label=tmp_label2,
                    as.numeric(tmp_fp$estimate), as.numeric(tmp_fp$conf.low), as.numeric(tmp_fp$conf.high), 
                    is.summary = c(T, rep(F, nrow(tmp_label2)-2), T), 
                    col=meta.colors(box="royalblue",line="darkblue",zero='gray0', summary="royalblue"), 
                    clip=c(-1.5,1.5), 
                    xlog=T, 
                    xlab='logOR',
                    zero=0, title(main = title, line = 0))
  mtext(paste(exposure, '\n', "het.pval=", formatC(tmp_meta$het[3], format='e', digits=2)), side = 1, line = 1)
}

```


# Counts {.tabset}
## asp_ref
```{r counts_asp_ref, message=F, echo=T, warning=F, tidy=T, cache=F}
x <- readRDS('./tables/counts_asp_ref.rds') %>% 
  rename_at(vars(col.from), function(x) col.to)

kable(x) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>% 
  add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>% 
  row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE")
  #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E")
```
## asp_ref2
```{r counts_asp_ref2, message=F, echo=T, warning=F, tidy=T, cache=F}
x <- readRDS('./tables/counts_asp_ref2.rds') %>% 
  rename_at(vars(col.from), function(x) col.to)

kable(x) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>% 
  add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>% 
  row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE")
  #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E")
```
## aspirin
```{r counts_aspirin, message=F, echo=T, warning=F, tidy=T, cache=F}
x <- readRDS('./tables/counts_aspirin.rds') %>% 
  rename_at(vars(col.from), function(x) col.to)

kable(x) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>% 
  add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>% 
  row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE")
  #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E")
```
## nsaids
```{r counts_nsaids, message=F, echo=T, warning=F, tidy=T, cache=F}
x <- readRDS('./tables/counts_nsaids.rds') %>% 
  rename_at(vars(col.from), function(x) col.to)

kable(x) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>% 
  add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>% 
  row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE")
  #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E")
```
<br>

# BarPlots {.tabset}
## aspirin
```{r barplots_aspirin, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13}
p <- readRDS("./figures/barplots_aspirin.rds")
p
```

## nsaids
```{r barplots_nsaids, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13}
p <- readRDS("./figures/barplots_nsaids.rds")
p
```

## asp_ref
```{r barplots_asp_ref, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13}
p <- readRDS("./figures/barplots_asp_ref.rds")
p
```
<br>

# Meta Analysis (Yi - Updated) {.tabset}

## aspirin  
```{r out.width=1400, echo = F}
knitr::include_graphics("./figures/yi_shiny_aspirin_FP.png")
```


## aspirin_ever  
```{r out.width=1400, echo = F}
knitr::include_graphics("./figures/yi_shiny_aspirinever_FP.png")
```


## nsaids  
```{r out.width=1400, echo = F}
knitr::include_graphics("./figures/yi_shiny_nsaids_FP.png")
```

## nsaids_ever  
```{r out.width=1400, echo = F}
knitr::include_graphics("./figures/yi_shiny_nsaidsever_FP.png")
```

## asp_ref  
```{r out.width=1400, echo = F}
knitr::include_graphics("./figures/yi_shiny_asp_ref_FP.png")
```


# Meta Analysis (AK) {.tabset}

Add additional plots as requested

## asp_ref
```{r forestplot_asp_ref, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5}
exposure <- 'asp_ref'
covars <- c("age_ref_imp", "sex")
title <- "Aspirin/NSAID use @ Ref Time \nModel: outcome~age_ref_imp+sex+asp_ref"

r_counts <- readRDS(paste0("./meta/r_counts_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
r_glm <- readRDS(paste0("./meta/r_glm_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
meta_fp(r_counts, r_glm, title = title)
```

## asp_ref (+smoke)
```{r forestplot_asp_ref_smoke, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5}
exposure <- 'asp_ref'
covars <- c("age_ref_imp", "sex", "smoke")
title <- "Aspirin/NSAID use @ Ref Time \nModel: outcome~age_ref_imp+sex+smoke+asp_ref"

r_counts <- readRDS(paste0("./meta/r_counts_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
r_glm <- readRDS(paste0("./meta/r_glm_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
meta_fp(r_counts, r_glm, title = title)
```

## aspirin
```{r forestplot_aspirin, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5}
exposure <- 'aspirin'
covars <- c("age_ref_imp", "sex")
title <- paste0("Aspirin use @ Ref Time \nModel: outcome~age_ref_imp+sex+", exposure)

r_counts <- readRDS(paste0("./meta/r_counts_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
r_glm <- readRDS(paste0("./meta/r_glm_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
meta_fp(r_counts, r_glm, title = title)
```

## nsaids
```{r forestplot_nsaids, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5}
exposure <- 'nsaids'
covars <- c("age_ref_imp", "sex")
title <- paste0("NSAID use @ Ref Time \nModel: outcome~age_ref_imp+sex+", exposure)

r_counts <- readRDS(paste0("./meta/r_counts_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
r_glm <- readRDS(paste0("./meta/r_glm_", exposure, "_", paste(covars, collapse = "_"), ".rds"))
meta_fp(r_counts, r_glm, title = title)
```


# Meta Analyses

```{r star, results = 'asis', warning=FALSE, message=FALSE}
library(stargazer, quietly = TRUE)
x <- readRDS("~/df.rds")

fit1 <- glm(outcome ~ asp_ref+age_ref_imp, x, family = 'binomial')
fit2 <- glm(outcome ~ asp_ref+age_ref_imp+sex, x, family = 'binomial')
fit3 <- glm(outcome ~ asp_ref+age_ref_imp+sex+PC1, x, family = 'binomial')

stargazer(fit1, fit2, fit3, type = 'html', single.row = T)
```



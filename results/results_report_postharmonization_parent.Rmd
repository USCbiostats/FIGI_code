---
title: "FIGI GWIS Results"
bibliography: /home/rak/Dropbox/library.bib
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: "united"
params:
  exposure: "asp_ref"
  is_exposure_categorical: TRUE
  energy_adj: FALSE
  covariates_suffix: "age_ref_imp_sex_study_gxe_pc1_pc2_pc3" # so far only thing that uses this is qq + manhattan plots (names)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, error = F)
```

<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  margin-top: 1em;
  margin-bottom: 1em;
}
body {
  font-family: Helvetica;
  font-size: 14pt;
}
h1.title {
  font-size: 24px;
  color: DarkRed;
}
h1 { 
  font-size: 22px;
}
h2 { 
    font-size: 20px;
}
h3 { 
  font-size: 18px;
}
table.Rtable1 {
    /* font-family: "Lucida Console", Monaco, monospace; */
    /* border-collapse: collapse; */
    font-size: 12pt;
}
.Rtable1 td.firstrow.rowlabel {
    /* background-color: yellow; */
    /* color: red; */
    font-size: 14pt;
}

</style>

```{r package_setup, include = F}
library(tidyverse)
library(data.table)
library(ggplot2)
library(qqman)
library(table1)
library(meta)
library(rlang)
library(broom)
library(effects)
library(figifs)
library(DT)
library(grid)
library(sjPlot)
library(stargazer)
library(nnet)
library(forcats)
library(kableExtra)
# library(expss)
```

```{r data_setup, include = F}
# use glm/gxescanr phenotype files to create subsets for descriptive, meta, and pooled analyses
# (to ensure same subset of individuals as gxescanr runs)
figi_gwas <- readRDS("~/data/FIGI_EpiData_rdata/FIGI_HRC_v2.3_GWAS.rds")
exposure_subset <- readRDS(paste0("~/data/GxEScanR_PhenotypeFiles/FIGI_v2.3_gxeset_", params$exposure, "_basic_covars_glm.rds"))$vcfid

# data for meta-analysis and pooled analysis
gxe <- figi_gwas %>%
  dplyr::filter(vcfid %in% exposure_subset) %>%
  dplyr::mutate(outcome = ifelse(outcome == "Control", 0, 1),
                sex = ifelse(sex == "Female", 0, 1))

if(params$is_exposure_categorical == T) {
  gxe[,params$exposure] <- (as.numeric(gxe[, params$exposure]) - 1) # this is only applicable for categorical variables 
}

# data for descriptive statistics table
# (add exposures here as you create the reports)


## (also, if you're using analytical subset, there shouldn't be NA factor level)
## keep this as old version if you need to go back to it
# gxe_table1 <- figi_gwas %>%
#   dplyr::filter(vcfid %in% exposure_subset) %>% 
#   dplyr::mutate(outcome = droplevels.factor(outcome), 
#                 table1_asp_ref = factor(asp_ref, exclude = NA, levels = c("No", "Yes", "P-value")),
#                 asp_ref = fct_explicit_na(asp_ref, na_level = "NA"), 
#                 asp_ref = fct_relevel(asp_ref, "No", "Yes", "NA"))

gxe_table1 <- figi_gwas %>%
  dplyr::filter(vcfid %in% exposure_subset) %>%
  dplyr::mutate(outcome = droplevels.factor(outcome),
                table1_asp_ref = factor(asp_ref, exclude = NA, levels = c("No", "Yes", "P-value")),
                asp_ref = fct_relevel(asp_ref, "No", "Yes"))

label(gxe_table1$age_ref_imp) <- "Age"
label(gxe_table1$alcoholc) <- "Alcohol Intake"
label(gxe_table1$asp_ref) <- "Reg Aspirin/NSAID use"
label(gxe_table1$bmi) <- "BMI"
label(gxe_table1$calcium_totqc2) <- "Total Calcium Intake"
label(gxe_table1$diab) <- "T2D (ever diagnosed)"
label(gxe_table1$educ) <- "Education (highest completed)"
label(gxe_table1$famhx1) <- "Family History of CRC"
label(gxe_table1$fiberqc2) <- "Total Fiber Intake"
label(gxe_table1$folate_totqc2) <- "Total Folate Intake"
label(gxe_table1$fruitqc2) <- "Total Fruit Intake"
label(gxe_table1$heightcm) <- "Height"
units(gxe_table1$heightcm) <- "cm"
label(gxe_table1$hrt_ref_pm) <- "Any Post-Menopausal HRT Use"
label(gxe_table1$outcome) <- "Outcome"
label(gxe_table1$procmeatqc2) <- "Total Processed Meat Intake"
label(gxe_table1$redmeatqc2) <- "Total Red Meat Intake"
label(gxe_table1$sex) <- "Sex"
label(gxe_table1$smoke) <- "Smoking Status"
label(gxe_table1$vegetableqc2) <- "Total Vegetable Intake"

# data for ggplots
# also includes variables for counts table
gxe_ggplot <- figi_gwas %>% 
  filter(gxe == 1, EUR_subset == 1) %>% 
  mutate(asp_ref = fct_explicit_na(asp_ref, na_level = "NA"), 
         asp_ref = fct_relevel(asp_ref, "NA", "Yes", "No"),
         asp_ref_count = fct_relevel(asp_ref, "No", "Yes", "NA"))

gxe_ggplot_subset <- gxe_ggplot %>% 
  filter(vcfid %in% exposure_subset)
```


# ``r params$exposure`` post-harmonization

## Summary of each section      
- Box/bar plots  
- Descriptive statistics by outcome and exposure status (when applicable) for CRC related variables. Only includes subset of samples with available ``r params$exposure`` information  
- Meta-analysis of CRC/``r params$exposure`` association. Results are presented overall and stratified by sex, tumor site, and relevant covariates  
- Pooled analysis of CRC/``r params$exposure`` in pooled FIGI GxE subset. Results also presented overall and stratified. Adjustment covariates same as those for meta-analyses, in addition to study_gxe    

<br>

--- 
 
<br>

<!-- ```{r child = paste0("results_report_child_descriptive_analysis.Rmd")} -->
<!-- ``` -->

# Meta-Analysis {.tabset}
```{r child = 'results_report_child_meta_analysis.Rmd'}
```

# Heterogeneity in pooled analysis {.tabset}
```{r child = 'results_report_child_pooled_analysis.Rmd'}
```


<!-- Descriptive analysis for hrt_ref_pm -->

## eo_ref_pm

<!-- ```{r, out.width = "85%"} -->
<!-- knitr::include_graphics("~/Dropbox/FIGI/Results/hrt_ref_pm/images/HRT_Variable_List.pdf") -->
<!-- ``` -->


```{r desc_data, include = F}
gxe_table1 <- gxe_table1 %>% 
  mutate(outcome = droplevels.factor(outcome), 
         table1_hrt_ref_pm = factor(hrt_ref_pm, exclude = NA, levels = c("No", "Yes", "P-value")))
label(gxe_table1$hrt_ref_pm) <- "Any post-menopausal HRT use @ ref time"
label(gxe_table1$outcome) <- "Outcome"
```


## Box Plot (All Studies)
```{r fig.height=18, fig.width=13}
gxe_ggplot <- figi_gwas %>% 
  filter(gxe == 1) %>% 
  mutate(hrt_ref_pm = fct_explicit_na(hrt_ref_pm, na_level = "NA"), 
         hrt_ref_pm = fct_relevel(hrt_ref_pm, "NA", "Yes", "No"))

ggplot(data=gxe_ggplot, aes(x=outc)) +
    geom_bar(aes(fill = hrt_ref_pm), position = 'fill') +
    theme_bw() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()) +
    scale_fill_manual(values = c("black", "red", "cyan")) +
    facet_wrap(vars(study_gxe), ncol = 5)

```




## Tables {.tabset}

### By outcome (Control/Case)
```{r, cache = T}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3),
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x),
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

# insert p values. hacky, requires an outcome factor with third level for p value.
# Also need to specify values by name (table1_outcome) in the 'rndr' function
rndr <- function(x, name, ...) {
  if (length(x) == 0) {
    y <- gxe_table1[[name]]
    s <- rep("", length(render.default(x=y, name=name, ...)))
    if (is.numeric(y)) {
      p <- t.test(y ~ gxe_table1$table1_outcome)$p.value
    } else {
      p <- chisq.test(table(y, droplevels(gxe_table1$table1_outcome)))$p.value
    }
    s[2] <- sub("<", "&lt;", format.pval(p, digits=3, eps=0.001))
    s
  } else {
    render.default(x=x, name=name, ...)
  }
}

rndr.strat <- function(label, n, ...) {
  ifelse(n==0, label, render.strat.default(label, n, ...))
}


covariates = c("age_ref_imp", "sex", "heightcm", "bmi", "famhx1", "educ", "smoke", "asp_ref", "diab", "calcium_totqc2", "folate_totqc2", "fiberqc2", "redmeatqc2", "procmeatqc2", "fruitqc2", "vegetableqc2")


table1(as.formula(paste0("~ ", "hrt_ref_pm", "+", paste(covariates, collapse = "+"), "| table1_outcome")),
       data=gxe_table1,
       render.continuous=my.render.cont,
       render.categorical=my.render.cat,
       render=rndr, render.strat=rndr.strat, overall = F, droplevels = F)

       
```



### By hrt_ref_pm (No/Yes)
```{r, cache = T}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3),
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x),
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

# insert p values. hacky, requires an outcome factor with third level for p value.
# In this case - using exposure
rndr <- function(x, name, ...) {
  if (length(x) == 0) {
    y <- gxe_table1[[name]]
    s <- rep("", length(render.default(x=y, name=name, ...)))
    if (is.numeric(y)) {
      p <- t.test(y ~ gxe_table1$hrt_ref_pm)$p.value
    } else {
      p <- chisq.test(table(y, droplevels(gxe_table1$hrt_ref_pm)))$p.value
    }
    s[2] <- sub("<", "&lt;", format.pval(p, digits=3, eps=0.001))
    s
  } else {
    render.default(x=x, name=name, ...)
  }
}

rndr.strat <- function(label, n, ...) {
  ifelse(n==0, label, render.strat.default(label, n, ...))
}

covariates = c("age_ref_imp", "sex", "heightcm", "bmi", "famhx1", "educ", "smoke", "asp_ref", "diab", "calcium_totqc2", "folate_totqc2", "fiberqc2", "redmeatqc2", "procmeatqc2", "fruitqc2", "vegetableqc2")


table1(as.formula(paste0("~ ", "outcome", "+", paste(covariates, collapse = "+"), "| table1_hrt_ref_pm")),
       data=gxe_table1,
       render.continuous=my.render.cont,
       render.categorical=my.render.cat,
       render=rndr, render.strat=rndr.strat, overall = F, droplevels = F)
```


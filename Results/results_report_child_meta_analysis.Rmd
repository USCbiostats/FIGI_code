<!-- For meta analyses, use the glm version of the gxescanr datasets you generated. 
These files don't have case-only studies, the exposure variables are filtered for missingness and are coded appropriately. 
Save posthoc and variable adjustment to the mega analysis, where you can generate multiple models and present as a table -->

<!-- data <- readRDS(paste0("~/data/GxEScanR_PhenotypeFiles/FIGI_GxESet_", "asp_ref", ".rds")) -->
<!-- data <- readRDS(paste0("~/data/GxEScanR_PhenotypeFiles/FIGI_gxeset_", "asp_ref", "_", "age_ref_imp_sex_study_gxe_pc1_pc2_pc3" , "_full.rds")) -->


### All
```{r, include=F, cache = T}
study_info <- readRDS("~/data/Annotations/FIGI_studygxe_info.rds")
gxe_counts <- get_counts_outcome_by_group(data, 'outcome', 'study_gxe')
gxe_glm <- get_estimates_e_by_group(data, 'outcome', params$exposure, 'study_gxe', 'age_ref_imp', 'sex')
# gxe_glm <- get_estimates_e_by_group(data, 'outcome', 'asp_ref', 'study_gxe', 'age_ref_imp', 'sex')

gxe_meta <- dplyr::bind_cols(gxe_counts, gxe_glm) %>%
  inner_join(., study_info, by = "study_gxe")

results_meta <- meta::metagen(estimate,
                std.error,
                data=gxe_meta,
                studlab=paste(study_gxe),
                comb.fixed = FALSE,
                comb.random = TRUE,
                method.tau = "SJ",
                hakn = TRUE,
                prediction=TRUE,
                sm="OR",
                byvar = study_design)

# png(paste0("~/Dropbox/twostep_wht_", statistic, "_", exposure, "_", paste0(covars, collapse = "_"), filename_suffix, ".png"), height = 10, width = 8, units = 'in')
# png("/media/work/tmp_images/test.png",height = 13, width = 8.5, units = 'in', res = 150)
png(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_sex_study_gxe.png"), height = 13, width = 8.5, units = 'in', res = 150)
meta::forest(results_meta,
       layout = "JAMA",
       # text.predict = "95% CI",
       # col.predict = "black",
       leftcols = c("studlab", "Control", "Case", "N", "effect", "ci", "w.random"),
       digits.addcols=0,
       study.results=T,
       prediction = F,
       col.random = 'red')
# grid.text("twtwefaewf", 0.5, 0.98, gp=gpar(cex=2))
dev.off()

png(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_sex_study_gxe.png"), height = 8, width = 8.5, units = 'in', res = 150)
meta::funnel(results_meta, sm="OR", studlab = T, pos = 4, col.random = 'red')
dev.off()
```
```{r  out.width="80%", echo = F, message = F, warning = F, cache = F}
knitr::include_graphics(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_sex_study_gxe.png"))
knitr::include_graphics(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_sex_study_gxe.png"))
```




### Sex
```{r, include=F, cache = T}

#### Females
tmp <- filter(data, sex == 0)

study_info <- readRDS("~/data/Annotations/FIGI_studygxe_info.rds")
gxe_counts <- get_counts_outcome_by_group(tmp, 'outcome', 'study_gxe')
gxe_glm <- get_estimates_e_by_group(tmp, 'outcome', params$exposure, 'study_gxe', 'age_ref_imp')
gxe_meta <- dplyr::bind_cols(gxe_counts, gxe_glm) %>%
  inner_join(., study_info, by = "study_gxe")

results_meta <- meta::metagen(estimate,
                std.error,
                data=gxe_meta,
                studlab=paste(study_gxe),
                comb.fixed = FALSE,
                comb.random = TRUE,
                method.tau = "SJ",
                hakn = TRUE,
                prediction=TRUE,
                sm="OR",
                byvar = study_design)

png(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_study_gxe_FEMALES.png"), height = 13, width = 8.5, units = 'in', res = 150)
meta::forest(results_meta,
       layout = "JAMA",
       # text.predict = "95% CI",
       # col.predict = "black",
       leftcols = c("studlab", "Control", "Case", "N", "effect", "ci", "w.random"),
       digits.addcols=0,
       study.results=T,
       prediction = F,
       col.random = 'red')
grid.text("FEMALES", 0.5, .98, gp=gpar(cex=2))
dev.off()

png(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_study_gxe_FEMALES.png"), height = 8, width = 8.5, units = 'in', res = 150)
meta::funnel(results_meta, sm="OR", studlab = T, pos = 4, col.random = 'red')
dev.off()


#### Males
tmp <- filter(data, sex == 1)

study_info <- readRDS("~/data/Annotations/FIGI_studygxe_info.rds")
gxe_counts <- get_counts_outcome_by_group(tmp, 'outcome', 'study_gxe')
gxe_glm <- get_estimates_e_by_group(tmp, 'outcome', params$exposure, 'study_gxe', 'age_ref_imp')
gxe_meta <- dplyr::bind_cols(gxe_counts, gxe_glm) %>%
  inner_join(., study_info, by = "study_gxe")

results_meta <- meta::metagen(estimate,
                std.error,
                data=gxe_meta,
                studlab=paste(study_gxe),
                comb.fixed = FALSE,
                comb.random = TRUE,
                method.tau = "SJ",
                hakn = TRUE,
                prediction=TRUE,
                sm="OR",
                byvar = study_design)

png(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_study_gxe_MALES.png"), height = 13, width = 8.5, units = 'in', res = 150)
meta::forest(results_meta,
       layout = "JAMA",
       # text.predict = "95% CI",
       # col.predict = "black",
       leftcols = c("studlab", "Control", "Case", "N", "effect", "ci", "w.random"),
       digits.addcols=0,
       study.results=T,
       prediction = F,
       col.random = 'red')
grid.text("MALES", 0.5, .98, gp=gpar(cex=2))
dev.off()

png(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_study_gxe_MALES.png"), height = 8, width = 8.5, units = 'in', res = 150)
meta::funnel(results_meta, sm="OR", studlab = T, pos = 4, col.random = 'red')
dev.off()


```
```{r echo=F, out.width="49%"}
knitr::include_graphics(c(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_study_gxe_FEMALES.png"),
                          paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_study_gxe_MALES.png")))
knitr::include_graphics(c(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_study_gxe_FEMALES.png"),
                          paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_study_gxe_MALES.png")))
```




### Tumor Site
```{r, include=F, cache = T}

#### Colon
# be mindful of small cell sizes after subsetting
tmp <- data %>% dplyr::filter(cancer_site_sum1 == "colon" | outcome == 0)

table(tmp$study_gxe, tmp$outcome)
sort(unique(tmp$study_gxe))
drops <- data.frame(table(tmp$study_gxe, tmp$outcome)) %>% 
  filter(Freq < 10)

tmp <- filter(tmp, !study_gxe %in% unique(drops$Var1))

# 
study_info <- readRDS("~/data/Annotations/FIGI_studygxe_info.rds")
gxe_counts <- get_counts_outcome_by_group(tmp, 'outcome', 'study_gxe')
gxe_glm <- get_estimates_e_by_group(tmp, 'outcome', params$exposure, 'study_gxe', 'age_ref_imp', 'sex')
# gxe_glm <- get_estimates_e_by_group(tmp, 'outcome', 'asp_ref', 'study_gxe', 'age_ref_imp', 'sex')

gxe_meta <- dplyr::bind_cols(gxe_counts, gxe_glm) %>%
  inner_join(., study_info, by = "study_gxe")

results_meta <- meta::metagen(estimate,
                std.error,
                data=gxe_meta,
                studlab=paste(study_gxe),
                comb.fixed = FALSE,
                comb.random = TRUE,
                method.tau = "SJ",
                hakn = TRUE,
                prediction=TRUE,
                sm="OR",
                byvar = study_design)

png(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_sex_study_gxe_COLON.png"), height = 13, width = 8.5, units = 'in', res = 150)
meta::forest(results_meta,
       layout = "JAMA",
       # text.predict = "95% CI",
       # col.predict = "black",
       leftcols = c("studlab", "Control", "Case", "N", "effect", "ci", "w.random"),
       digits.addcols=0,
       study.results=T,
       prediction = F,
       col.random = 'red')
grid.text("Colon", 0.5, .98, gp=gpar(cex=2))
dev.off()

png(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_sex_study_gxe_COLON.png"), height = 8, width = 8.5, units = 'in', res = 150)
meta::funnel(results_meta, sm="OR", studlab = T, pos = 4, col.random = 'red')
dev.off()


#### Rectum
tmp <- data %>% dplyr::filter(cancer_site_sum1 == "rectal" | outcome == 0)

table(tmp$study_gxe, tmp$outcome)
sort(unique(tmp$study_gxe))
drops <- data.frame(table(tmp$study_gxe, tmp$outcome)) %>% 
  filter(Freq < 10)

tmp <- filter(tmp, !study_gxe %in% unique(drops$Var1))

study_info <- readRDS("~/data/Annotations/FIGI_studygxe_info.rds")
gxe_counts <- get_counts_outcome_by_group(tmp, 'outcome', 'study_gxe')
gxe_glm <- get_estimates_e_by_group(tmp, 'outcome', params$exposure, 'study_gxe', 'age_ref_imp', 'sex')
gxe_meta <- dplyr::bind_cols(gxe_counts, gxe_glm) %>%
  inner_join(., study_info, by = "study_gxe")

results_meta <- meta::metagen(estimate,
                std.error,
                data=gxe_meta,
                studlab=paste(study_gxe),
                comb.fixed = FALSE,
                comb.random = TRUE,
                method.tau = "SJ",
                hakn = TRUE,
                prediction=TRUE,
                sm="OR",
                byvar = study_design)

png(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_sex_study_gxe_RECTUM.png"), height = 13, width = 8.5, units = 'in', res = 150)
meta::forest(results_meta,
       layout = "JAMA",
       # text.predict = "95% CI",
       # col.predict = "black",
       leftcols = c("studlab", "Control", "Case", "N", "effect", "ci", "w.random"),
       digits.addcols=0,
       study.results=T,
       prediction = F,
       col.random = 'red')
grid.text("Rectum", 0.5, .98, gp=gpar(cex=2))
dev.off()

png(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_sex_study_gxe_RECTUM.png"), height = 8, width = 8.5, units = 'in', res = 150)
meta::funnel(results_meta, sm="OR", studlab = T, pos = 4, col.random = 'red')
dev.off()


```
```{r echo=F, out.width="49%"}
knitr::include_graphics(c(paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_sex_study_gxe_COLON.png"),
                          paste0("/media/work/tmp_images/meta_analysis_", params$exposure, "age_ref_imp_sex_study_gxe_RECTUM.png")))
knitr::include_graphics(c(paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_sex_study_gxe_COLON.png"),
                          paste0("/media/work/tmp_images/funnel_plot_", params$exposure, "age_ref_imp_sex_study_gxe_RECTUM.png")))
```



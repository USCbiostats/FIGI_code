---
title: "FIGI NSAID GxE Analysis"
# bibliography: /home/mak/Dropbox/library.bib
output: 
  html_document:
    css: ./rds/styles_rmarkdown.css
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    theme: united
---

<!-- Use this to make window large in html file -->
<style type="text/css">
.main-container {
  max-width: 1500px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r setup, echo=F, message=F, cache=F}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(broom)
library(table1)
library(kableExtra)
library(rlang)
library(rmeta)
library(qqman) 
library(DT)
library(htmltools)
library(sjPlot)

# functions
meta_fp <- function(counts_df, results_df, title) {
  tmp_meta <- meta.summaries(results_df$estimate, results_df$std.error, method = 'random')
  tmp_meta_b_ci <- c(tmp_meta[[3]], tmp_meta[[3]]-(tmp_meta[[4]]*1.96), tmp_meta[[3]]+(tmp_meta[[4]]*1.96))
  tmp_fp <- dplyr::select(results_df, estimate, conf.low, conf.high)
  tmp_fp <- rbind(rep(NA, 3), tmp_fp, rep(NA, 3), tmp_meta_b_ci)
  tmp_label_summary <- c("Summary", sum(counts_df$N), sum(counts_df$Case), round(tmp_meta[[3]], 2), round(tmp_meta[[4]], 3), round(exp(tmp_meta[[3]]), 2), round(tmp_meta[[5]][2], 4))
  tmp_label <- inner_join(counts_df, results_df, by = 'studyname') %>% 
    mutate(Study = as.character(studyname), 
           OR = round(exp(estimate), 2),
           Pvalue = round(p.value, 4),
           SE = round(std.error, 3),
           beta = round(estimate, 2)) %>% 
    dplyr::select(Study, N, Case, beta, SE, OR, Pvalue)
  tmp_label2 <- rbind(colnames(tmp_label), tmp_label, rep(NA, 7), tmp_label_summary)
  rmeta::forestplot(label=tmp_label2,
                    as.numeric(tmp_fp$estimate), as.numeric(tmp_fp$conf.low), as.numeric(tmp_fp$conf.high), 
                    is.summary = c(T, rep(F, nrow(tmp_label2)-2), T), 
                    col=meta.colors(box="royalblue",line="darkblue",zero='gray0', summary="royalblue"), 
                    clip=c(-1.5,1.5), 
                    xlog=T, 
                    xlab='logOR',
                    zero=0, title(main = title, line = 0))
  mtext(paste(exposure, '\n', "het.pval=", formatC(tmp_meta$het[3], format='e', digits=2)), side = 1, line = 1)
}

```

# Counts - Tables {.tabset}

## asp_ref
```{r counts_asp_ref, echo=F, warning = F, tidy = T, message=F, cache=F}

df <- readRDS("rds/counts_asp_ref.rds") %>% 
  dplyr::select(study_gxe, Case_No, Case_Yes, Case_, Control_No, Control_Yes, Control_)

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'study_gxe'),
      th(colspan = 3, 'Cases'),
      th(colspan = 3, 'Controls')
    ),
    tr(
      lapply(rep(c('No', 'Yes', 'NA'), 2), th)
    )
  )
))

datatable(df, rownames = F,  container = sketch, caption = "asp_ref counts by study/outcome - n (%)")
```

## aspirin
```{r counts_aspirin, echo=F, warning = F, tidy = T, message=F, cache=F}

df <- readRDS("rds/counts_aspirin.rds") %>% 
  dplyr::select(study_gxe, Case_No, Case_Yes, Case_, Control_No, Control_Yes, Control_)

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'study_gxe'),
      th(colspan = 3, 'Cases'),
      th(colspan = 3, 'Controls')
    ),
    tr(
      lapply(rep(c('No', 'Yes', 'NA'), 2), th)
    )
  )
))

library(DT)
library(htmltools)
datatable(df, rownames = F,  container = sketch, caption = "aspirin counts by study/outcome - n (%)")
```
<br>


# Counts - Barplots {.tabset}
## asp_ref
```{r barplots_asp_ref, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13}
p <- readRDS("figures/barplot_asp_ref.rds")  
p
```

## aspirin
```{r barplots_aspirin, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13}
p <- readRDS("figures/barplot_aspirin.rds")  
p
```

<br>

# Table 1 {.tabset}

## asp_ref (Outcome)
```{r table1_asp_ref_O, echo=F, warning = F, tidy = T, message=F, cache=F}
df <- readRDS("rds/df_table1.rds")

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=2),
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
  c("", sapply(stats.default(x),
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

table1(~ age_ref_imp + sex + asp_ref | outcome ,
       data=df,
       render.continuous=my.render.cont,
       render.categorical=my.render.cat)
```
<br>

## asp_ref (Exposure)
```{r table1_asp_ref_E, echo=F, warning = F, tidy = T, message=F, cache=F}
df <- readRDS("rds/df_table1.rds")

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=2),
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
  c("", sapply(stats.default(x),
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

table1(~ age_ref_imp + sex + outcome | asp_ref ,
       data=df,
       render.continuous=my.render.cont,
       render.categorical=my.render.cat)
```
<br>

# Exposure Main Effects {.tabset}

## asp_ref meta-analysis
```{r meta_asp_ref, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5}
knitr::include_graphics("figures/forestplot_asp_ref.png")
```

## asp_ref mega-analysis
```{r mega_asp_ref, message=F, echo=T, warning=F, tidy=F, cache=T}
glm1 <- readRDS("rds/mega_analysis_glm1.rds")
tab_model(glm1)
```






<!-- # Exposure Variable Counts by Case/Control + Study  {.tabset} -->
<!-- ```{r counts_setup, echo=F, message=F, cache=F} -->
<!-- # for counts tables -->
<!-- col.from <- c('Case_No', 'Case_Yes', 'Case_', 'Control_No', 'Control_Yes', 'Control_') -->
<!-- col.to <- c('No', 'Yes', 'NAs', 'No', 'Yes', 'NAs') -->

<!-- ``` -->

<!-- ## asp_ref -->
<!-- ```{r counts_asp_ref, message=F, echo=T, warning=F, tidy=T, cache=F} -->
<!-- x <- readRDS('./rds/counts_asp_ref.rds') %>% -->
<!-- 	dplyr::select(study_gxe, Case_No, Case_Yes, Case_, Control_No, Control_Yes, Control_) %>%  -->
<!--   rename_at(vars(col.from), function(x) col.to) -->

<!-- kable(x) %>% -->
<!--   kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>%  -->
<!--   add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>%  -->
<!--   row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE") -->
<!--   #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E") -->
<!-- ``` -->
<!-- ## aspirin -->
<!-- ```{r counts_aspirin, message=F, echo=T, warning=F, tidy=T, cache=F} -->
<!-- x <- readRDS('./rds/counts_aspirin.rds') %>% -->
<!-- 	dplyr::select(study_gxe, Case_No, Case_Yes, Case_, Control_No, Control_Yes, Control_) %>%  -->
<!--   rename_at(vars(col.from), function(x) col.to) -->

<!-- kable(x) %>% -->
<!--   kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>%  -->
<!--   add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>%  -->
<!--   row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE") -->
<!--   #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E") -->
<!-- ``` -->
<!-- ## nsaids -->
<!-- ```{r counts_nsaids, message=F, echo=T, warning=F, tidy=T, cache=F} -->
<!-- x <- readRDS('./rds/counts_nsaids.rds') %>% -->
<!-- 	dplyr::select(study_gxe, Case_No, Case_Yes, Case_, Control_No, Control_Yes, Control_) %>%  -->
<!--   rename_at(vars(col.from), function(x) col.to) -->

<!-- kable(x) %>% -->
<!--   kable_styling(bootstrap_options = "striped", full_width = F, position = 'left') %>%  -->
<!--   add_header_above(c(" " = 1, "Cases (%)" = 3, "Controls (%)" = 3)) %>%  -->
<!--   row_spec(nrow(x), bold = T, color = "black", background = "#EAECEE") -->
<!--   #row_spec(nrow(x), bold = T, color = "white", background = "#D7261E") -->
<!-- ``` -->
<!-- <br> -->

<!-- # BarPlots {.tabset} -->
<!-- ## asp_ref -->
<!-- ```{r barplots_asp_ref, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13} -->
<!-- p <- readRDS("./figures/barplot_asp_ref.rds") -->
<!-- p -->
<!-- ``` -->

<!-- ## aspirin -->
<!-- ```{r barplots_aspirin, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13} -->
<!-- p <- readRDS("./figures/barplot_aspirin.rds") -->
<!-- p -->
<!-- ``` -->

<!-- ## nsaids -->
<!-- ```{r barplots_nsaids, message=F, echo=T, warning=F, tidy=T, cache=T, fig.height=16, fig.width=13} -->
<!-- p <- readRDS("./figures/barplot_nsaids.rds") -->
<!-- p -->
<!-- ``` -->
<!-- <br> -->


<!-- # Meta Analysis (YL) {.tabset} -->
<!-- ## asp_ref   -->
<!-- ```{r out.width=1400, echo = F} -->
<!-- knitr::include_graphics("./figures/yi_shiny_asp_ref_FP.png") -->
<!-- ``` -->

<!-- ## aspirin   -->
<!-- ```{r out.width=1400, echo = F} -->
<!-- knitr::include_graphics("./figures/yi_shiny_aspirin_FP.png") -->
<!-- ``` -->

<!-- ## nsaids   -->
<!-- ```{r out.width=1400, echo = F} -->
<!-- knitr::include_graphics("./figures/yi_shiny_nsaids_FP.png") -->
<!-- ``` -->


<!-- # Meta Analysis (AK) {.tabset} -->

<!-- Add additional plots as needed -->

<!-- ## asp_ref -->
<!-- ```{r forestplot_asp_ref, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5} -->
<!-- knitr::include_graphics("./figures/forestplot_asp_ref.png") -->
<!-- ``` -->

<!-- ## aspirin -->
<!-- ```{r forestplot_aspirin, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5} -->
<!-- knitr::include_graphics("./figures/forestplot_aspirin.png") -->
<!-- ``` -->

<!-- ## nsaids -->
<!-- ```{r forestplot_nsaids, message=F, echo=T, warning=F, tidy=F, cache=T, fig.width = 8, fig.height = 13.5} -->
<!-- knitr::include_graphics("./figures/forestplot_nsaids.png") -->
<!-- ``` -->
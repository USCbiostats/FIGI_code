<!-- Descriptive analysis for asp_ref -->


## Variable Information

![](/home/rak/Dropbox/FIGI/Results/asp_ref/figures/nsaids_variable_list.png)

<br><br><br><br>
Notes:

Boxplots are generated using entire GxE set (N = 100K)

Descriptive tables, meta analyses, and pooled analyses only include a subset of individuals:  
- asp_ref available (!is.na)  
- EUR only  
<br><br><br><br>

```{r desc_data, include = F}
data_boxplot <- readRDS("~/data/GxEScanR_PhenotypeFiles/FIGI_gxeset_EUR.rds") %>% 
  dplyr::mutate(asp_ref = factor(asp_ref, exclude = NULL, labels = c("NA", "No", "Yes")))
# table(data_boxplot$asp_ref, data_boxplot$asp_ref_tmp, useNA = 'ifany')


# Table1 cleaned and labeled data
# categorical variables should be factors, with appropriately named levels
# (should not include observations with missing asp_ref in tabulation
# revisit as necessary..)
data_table <- data_boxplot %>%
  dplyr::filter(asp_ref != "NA") %>%
  mutate(outcome = factor(outc, exclude = NULL, levels = c("Control", "Case")), 
         table1_outcome = factor(outcome, exclude = NULL, levels = c("Control", "Case", "P-value")),
         # continuous variables
         age_ref_imp = as.numeric(age_ref_imp),
         bmi = as.numeric(bmi), 
         heightcm = as.numeric(heightcm),
         # categorical
         sex = factor(sex, exclude = NULL, labels = c("Female", "Male")), 
         famhx1 = factor(famhx1, exclude = NULL, labels = c("Missing", "No", "Yes")),
         famhx1 = fct_relevel(famhx1, "Missing", after = Inf), 
         educ = factor(educ, exclude = NULL, labels = c("Missing", "Less than High School", "High School/GED", "Some College", "College/Graduate School")), 
         educ = fct_relevel(educ, "Missing", after = Inf), 
         smoke = factor(smoke, exclude = NULL, labels = c("Missing", "Former smoker", "Never smoker", "Smoker")),
         smoke = fct_relevel(smoke, "Never smoker", "Former smoker",  "Smoker" , "Missing"),
         alcoholc = factor(alcoholc, exclude = NULL, labels = c("Missing", "Heavy drinker", "Moderate drinker", "Nondrinker")), 
         alcoholc = fct_relevel(alcoholc, "Nondrinker", "Moderate drinker", "Heavy drinker" , "Missing"),
         hrt_ref_pm = factor(hrt_ref_pm, exclude = NULL, labels = c("Missing", "No", "Yes")), 
         hrt_ref_pm = fct_relevel(hrt_ref_pm, "Missing", after = Inf), 
         diab = factor(diab, exclude = NULL, labels = c("Missing", "No", "Yes")), 
         diab = fct_relevel(diab, "Missing", after = Inf), 
         calcium_totqc2 = factor(calcium_totqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         calcium_totqc2 = fct_relevel(calcium_totqc2, "Missing", after = Inf),
         folate_totqc2 = factor(folate_totqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         folate_totqc2 = fct_relevel(folate_totqc2, "Missing", after = Inf),
         fiberqc2 = factor(fiberqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         fiberqc2 = fct_relevel(fiberqc2, "Missing", after = Inf),         
         redmeatqc2 = factor(redmeatqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         redmeatqc2 = fct_relevel(redmeatqc2, "Missing", after = Inf),
         procmeatqc2 = factor(procmeatqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         procmeatqc2 = fct_relevel(procmeatqc2, "Missing", after = Inf),
         fruitqc2 = factor(fruitqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         fruitqc2 = fct_relevel(fruitqc2, "Missing", after = Inf),
         vegetableqc2 = factor(vegetableqc2, exclude = NULL, labels = c("Missing", "Q1", "Q2", "Q3", "Q4")),
         vegetableqc2 = fct_relevel(vegetableqc2, "Missing", after = Inf),
         # Exposure specific (include more variables than other Es)
         # asp_ref = factor(asp_ref, exclude = NULL, labels = c("Missing", "No", "Yes")), 
         # asp_ref = fct_relevel(asp_ref, "Missing", after = Inf))
         asp_ref = factor(asp_ref, exclude = NULL, labels = c("No", "Yes")),
         table1_asp_ref = factor(asp_ref, exclude = NULL, levels = c("No", "Yes", "P-value")))
# 
# table(data_boxplot$redmeatqc2)
# table(data_table$redmeatqc2)

# wtf <- factor(data_boxplot$outc, exclude = NULL, levels = c("Control", "Case"))
# table(wtf); levels(wtf)
# 
# wtf2 <- factor(wtf, exclude = NULL, levels = c("Control", "Case", "P-value"))
# table(wtf2); levels(wtf2)

  # dat <- dat %>%
  #   dplyr::filter(!is.na(!! exposure)) %>%
  #   dplyr::mutate(table1_outcome = factor(!! outcome, levels = c(0,1,2), labels=c("Control", "Case", "P-value"))) %>%
  #   dplyr::mutate_at(., setdiff(covariates, covarCat), as.numeric) %>%
  #   dplyr::mutate_at(., covarCat, as.factor)
  # 

label(data_table$outcome) <- "Outcome"
label(data_table$sex) <- "Sex"
label(data_table$age_ref_imp) <- "Age"
label(data_table$bmi) <- "BMI"
label(data_table$heightcm) <- "Height"
label(data_table$famhx1) <- "Family History of CRC"
label(data_table$educ) <- "Education (highest completed)"
label(data_table$smoke) <- "Smoking Status"

label(data_table$alcoholc) <- "Alcohol Intake"
label(data_table$hrt_ref_pm) <- "Any Post-Menopausal HRT Use"
label(data_table$diab) <- "T2D (ever diagnosed)"
label(data_table$calcium_totqc2) <- "Total Calcium Intake"
label(data_table$folate_totqc2) <- "Total Folate Intake"
label(data_table$fiberqc2) <- "Total Fiber Intake"
label(data_table$redmeatqc2) <- "Total Red Meat Intake"
label(data_table$procmeatqc2) <- "Total Processed Meat Intake"
label(data_table$fruitqc2) <- "Total Fruit Intake"
label(data_table$vegetableqc2) <- "Total Vegetable Intake"

units(data_table$heightcm) <- "cm"
```


## Box Plot (All Studies)
```{r fig.height=18, fig.width=13}
ggplot(data=data_boxplot, aes(x=outc)) +
    geom_bar(aes(fill = asp_ref), position = 'fill') +
    theme_bw() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()) +
    scale_fill_manual(values = c("black", "cyan", "red")) +
    facet_wrap(vars(study_gxe), ncol = 5)

```




## Tables {.tabset}

### By disease status (Control/Case)
```{r, cache = T}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3),
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x),
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

# insert p values. hacky, requires an outcome factor with third level for p value.
# Also need to specify values by name (table1_outcome) in the 'rndr' function
rndr <- function(x, name, ...) {
  if (length(x) == 0) {
    y <- data_table[[name]]
    s <- rep("", length(render.default(x=y, name=name, ...)))
    if (is.numeric(y)) {
      p <- t.test(y ~ data_table$table1_outcome)$p.value
    } else {
      p <- chisq.test(table(y, droplevels(data_table$table1_outcome)))$p.value
    }
    s[2] <- sub("<", "&lt;", format.pval(p, digits=3, eps=0.001))
    s
  } else {
    render.default(x=x, name=name, ...)
  }
}

rndr.strat <- function(label, n, ...) {
  ifelse(n==0, label, render.strat.default(label, n, ...))
}


exposure = "asp_ref"
covariates = c("age_ref_imp", "sex", "heightcm", "bmi", "famhx1", "educ", "smoke", "alcoholc", "hrt_ref_pm", "diab", "calcium_totqc2", "folate_totqc2", "fiberqc2", "redmeatqc2", "procmeatqc2", "fruitqc2", "vegetableqc2")


table1(as.formula(paste0("~ ", "asp_ref", "+", paste(covariates, collapse = "+"), "| table1_outcome")),
       data=data_table,
       render.continuous=my.render.cont,
       render.categorical=my.render.cat,
       render=rndr, render.strat=rndr.strat, overall = F, droplevels = F)
```



### By exposure status (asp_ref)
```{r, cache = T}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3),
       c("", "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x),
               function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

# insert p values. hacky, requires an outcome factor with third level for p value.
# In this case - using exposure
rndr <- function(x, name, ...) {
  if (length(x) == 0) {
    y <- data_table[[name]]
    s <- rep("", length(render.default(x=y, name=name, ...)))
    if (is.numeric(y)) {
      p <- t.test(y ~ data_table$asp_ref)$p.value
    } else {
      p <- chisq.test(table(y, droplevels(data_table$asp_ref)))$p.value
    }
    s[2] <- sub("<", "&lt;", format.pval(p, digits=3, eps=0.001))
    s
  } else {
    render.default(x=x, name=name, ...)
  }
}

rndr.strat <- function(label, n, ...) {
  ifelse(n==0, label, render.strat.default(label, n, ...))
}


exposure = "asp_ref"
covariates = c("age_ref_imp", "sex", "heightcm", "bmi", "famhx1", "educ", "smoke", "alcoholc", "hrt_ref_pm", "diab", "calcium_totqc2", "folate_totqc2", "fiberqc2", "redmeatqc2", "procmeatqc2", "fruitqc2", "vegetableqc2")


table1(as.formula(paste0("~ ", "outcome", "+", paste(covariates, collapse = "+"), "| table1_asp_ref")),
       data=data_table,
       render.continuous=my.render.cont,
       render.categorical=my.render.cat,
       render=rndr, render.strat=rndr.strat, overall = F, droplevels = F)


# things look weird for t.tests... let me check
# (nevermind, rounding)
# p <- t.test(data_table$heightcm ~ data_table$asp_ref)
# p
```


---
title: "FIGI Analysis - folate_dietqc2"
bibliography: /home/rak/Dropbox/library.bib
output: 
  #pdf_document:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: "united"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r package_setup, include = F}
library(tidyverse)
library(data.table)
library(ggplot2)
library(qqman)
library(table1)
library(rmeta)
library(rlang)
library(broom)
source("/home/rak/Dropbox/FIGI/Code/Functions/FIGI_PostHarmonization_Functions.R")
```


```{r data_setup, include = F}
pca <- "/home/rak/data/PCA/190506/FIGI_GxESet_KGP_pc20_190430.eigenvec"
load("~/data/FIGI_EpiData_rdata/FIGI_Genotype_Epi_190424.RData")

# slightly different from epiData scripts
# keep it minimal: 
# - filter drop/gxe
# - only fix outcome, E, and 'colo2&3' study_gxe name
# leave everything else to the functions
pc30k <- fread(pca, skip = 1, 
               col.names = c("FID", "IID", paste0(rep("PC", 20), seq(1,20))))
cov <- figi %>%
  filter(drop == 0 & gxe == 1) %>% 
  inner_join(pc30k, by = c('vcfid' = 'IID')) %>% 
  mutate(outcome = ifelse(outc == "Case", 1, 0),
         age_ref_imp = as.numeric(age_ref_imp),
         sex = ifelse(sex == "Female", 0, 1),
         study_gxe = ifelse(study_gxe == "Colo2&3", "Colo23", study_gxe),
         energytot = as.numeric(energytot), 
         folate_dietqc2 = as.numeric(folate_dietqc2)) # need to be careful = easiest when it's numeric
```

# Postharmonization

## BoxPlots {.tabset}
```{r, echo = F, message = F, cache = T, fig.height=18, fig.width=13}
createBarPlot(cov, outcome, folate_dietqc2, c(NA,4,3,2,1), c("NA", "4", "3", "2", "1"), c( "black", "red", "green", "cyan", "purple"))
```
<br><br><br>


## Tables {.tabset}

### Overall
```{r, echo = F, message = F, cache = F}
varlist <- c("age_ref_imp", "sex", "education", "smoke", "bmi", "famhx1", "calcium_tot", "fruit", "vegetable", "redmeat", "procmeat")
varlistCat <- c("sex", "education", "smoke", "famhx1", "folate_dietqc2")
createTable1(cov, outcome, folate_dietqc2, varlist, varlistCat) 
```
<br><br><br>

### cancer_site_sum1 = 'colon'
```{r, echo = F, message = F, cache = F}
createTable1(cov %>% filter(cancer_site_sum1 == "colon" | outcome == 0), outcome, folate_dietqc2, varlist, varlistCat)
```
<br><br><br>

### cancer_site_sum1 = 'rectal'
```{r, echo = F, message = F, cache = F}
createTable1(cov %>% filter(cancer_site_sum1 == "rectal" | outcome == 0), outcome, folate_dietqc2, varlist, varlistCat)
```
<br><br><br>




## Meta Analyses {.tabset}

### All tumor sites
```{r, echo = F, message = F, cache = T, fig.height=13, fig.width=13}
meta_covars <- c("age_ref_imp", "sex", "energytot")

x <- getCounts_byOutcome(cov, outcome, folate_dietqc2)
y <- getGLM_byGroup(cov, outcome, folate_dietqc2, meta_covars)
run_meta_analysis_create_forestplot(x, y, paste0("Dietary folate intake (Q4) \nModel: outcome~folate_dietqc2+", paste(meta_covars, collapse = "+")))
```
<br><br><br>

### cancer_site_sum1 = 'colon'
```{r, echo = F, message = F, cache = T, fig.height=13, fig.width=13}
tmp <- cov %>% filter(cancer_site_sum1 == "colon" | outcome == 0)

x <- getCounts_byOutcome(tmp, outcome, folate_dietqc2)
y <- getGLM_byGroup(tmp, outcome, folate_dietqc2, meta_covars)
run_meta_analysis_create_forestplot(x, y, paste0("Dietary folate intake (Q4) \nModel: outcome~folate_dietqc2+", paste(meta_covars, collapse = "+")))
```
<br><br><br>

### cancer_site_sum1 = 'rectal'
```{r, echo = F, message = F, cache = T, fig.height=13, fig.width=13}
tmp <- cov %>% filter(cancer_site_sum1 == "rectal" | outcome == 0)

x <- getCounts_byOutcome(tmp, outcome, folate_dietqc2)
y <- getGLM_byGroup(tmp, outcome, folate_dietqc2, meta_covars)
run_meta_analysis_create_forestplot(x, y, paste0("Dietary folate intake (Q4) \nModel: outcome~folate_dietqc2+", paste(meta_covars, collapse = "+")))
```
<br><br><br>




# Results

## Main Results (WtAvg Rsq > 0.8) {.tabset}

### chiSqG
```{r , echo=FALSE, out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSqG_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
knitr::include_graphics("figures/EasyStrata_chiSqG_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.txt.mh.png")
```
<br><br><br>
---------------------------------------------------------

### chiSqGxE
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSqGxE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
knitr::include_graphics("figures/EasyStrata_chiSqGxE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.txt.mh.png")
```
<br><br><br>
---------------------------------------------------------

### 2DF
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSq2df_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
knitr::include_graphics("figures/EasyStrata_chiSq2df_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.txt.mh.png")
```
<br><br><br>
---------------------------------------------------------

### 3DF
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSq3df_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
knitr::include_graphics("figures/EasyStrata_chiSq3df_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.txt.mh.png")
```
<br><br><br>
---------------------------------------------------------

### chiSqGE (QQ)
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSqGE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
---------------------------------------------------------

### chiSqControl (QQ)
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSqControl_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
---------------------------------------------------------

### chiSqCase
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/QQ_Plot_chiSqCase_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
knitr::include_graphics("figures/EasyStrata_chiSqCase_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.txt.mh.png")
```
<br><br><br>
---------------------------------------------------------

### 2-Step (chiSqG)
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/TwoStep_WeightedHypothesis_gxe_normal_chiSqG_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
---------------------------------------------------------

### 2-Step (chiSqGE)
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/TwoStep_WeightedHypothesis_gxe_normal_chiSqGE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
---------------------------------------------------------

### 2-Step (chiSqEDGE)
```{r , echo=FALSE,  out.width = '100%'}
knitr::include_graphics("figures/TwoStep_WeightedHypothesis_gxe_normal_chiSqEDGE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
---------------------------------------------------------


## Main Results (WtAvg Rsq > 0.8 + LD CLUMPING) {.tabset}

### chiSqGxE 2-step (chiSqG)
```{r , echo=FALSE, out.width = '100%'}
knitr::include_graphics("figures/TwoStep_WeightedHypothesis_gxe_twostep_ld_chiSqG_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br>
---------------

### chiSqGxE 2-step (chiSqGE)
```{r , echo=FALSE, out.width = '100%'}
knitr::include_graphics("figures/TwoStep_WeightedHypothesis_gxe_twostep_ld_chiSqGE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br>
---------------

### chiSqGxE 2-step (chiSqEDGE)
```{r , echo=FALSE, out.width = '100%'}
knitr::include_graphics("figures/TwoStep_WeightedHypothesis_gxe_twostep_ld_chiSqEDGE_folate_dietqc2_age_ref_imp_sex_study_gxe_PC1-3_energytot_N_52447.png")
```
<br><br><br>
---------------
